---
# Downloads and unpacks a copy of synthetic tree and OTT into correct
# location for webservices
# Used in cases where synthesis not run locally

- name: Create unpacked_dir
  file:
    path: "{{ unpacked_dir }}"
    state: directory

- name: Create downloads_dir
  file:
    path: "{{ downloads_dir }}"
    state: directory

## download, unpack, and copy OTT
- name: Download copy of OTT from files server
  get_url:
    url: "{{ ott_url }}"
    dest: "{{ downloads_dir }}"
    creates: "{{ downloads_dir }}/ott{{ ott_version }}.tgz"

- name: Uncompress OTT
  unarchive:
    src: "{{ downloads_dir }}/{{ ott_version }}.tgz"
    dest: "{{ unpacked_dir }}"
    creates: "{{ unpacked_dir }}/ott{{ ott_version }}/taxonomy.tsv"
    remote_src: yes

- name: Copy OTT from unpacked_dir to ws dir
  copy:
    src: "{{ unpacked_dir }}/ott/{{ ott_version }}"
    dest: "{{ otc_ws_data }}/"
    remote_src: true
    mode: preserve

## download, unpack, and copy synthesis tree
- name: Download copy of synth tree from files server
  get_url:
    url: "{{ synth_tree_url }}"
    dest: "{{ downloads_dir }}"
    creates: "{{ downloads_dir }}/opentree{{ synth_version }}.tgz"

- name: Uncompress synth tree
  unarchive:
    src: "{{ downloads_dir }}/opentree{{ synth_version }}.tgz"
    dest: "{{ unpacked_dir }}"
    creates: "{{ unpacked_dir }}/opentree{{ synth_version }}/index.json"
    remote_src: yes

- name: Copy synth tree from unpacked_dir to ws dir
  copy:
    src: "{{ unpacked_dir }}/opentree{{ synth_version }}"
    dest: "{{ otc_ws_data }}/"
    remote_src: true
    mode: preserve
